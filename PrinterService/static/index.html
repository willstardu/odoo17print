<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å†…ç½‘æ‰“å°æœåŠ¡</title>
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background: #f8f9fa; 
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .main-container { 
            height: 100vh;
            display: flex;
            margin: 0;
            padding: 0;
        }
        
        .left-panel {
            width: 45%;
            background: #fff;
            border-right: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .left-content {
            padding: 20px;
            flex: 1;
        }
        
        .right-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }
        
        h1 { 
            font-size: 1.8rem; 
            margin-bottom: 1rem; 
            color: #333;
        }
        .form-label { font-weight: 500; }
        .log-list { 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 0.9em; 
            margin-bottom: 0;
        }
        .supported-formats { 
            font-size: 0.9em; 
            color: #6c757d; 
            margin-top: 0.5rem; 
        }
        .conversion-info { 
            background: #e8f5e8; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            font-size: 0.85em; 
        }
        .status-good { color: #28a745; font-weight: bold; }
        .status-missing { color: #dc3545; }
        .silent-print-info { 
            background: #e3f2fd; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            font-size: 0.9em;
        }
        
        .drop-zone {
            flex: 1;
            border: 3px dashed #007bff;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 0;
            min-height: 40%;
            position: relative;
        }
        .drop-zone:hover {
            border-color: #0056b3;
            background: #e6f3ff;
        }
        .drop-zone.dragover {
            border-color: #0056b3;
            background: #cce7ff;
            color: #0056b3;
        }
        .drop-zone i {
            font-size: 4rem;
            color: #007bff;
            margin-bottom: 15px;
        }
        .drop-zone h3 {
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .file-list-container {
            flex: 1;
            background: #fff;
            border-top: 2px solid #e0e0e0;
            overflow-y: auto;
            max-height: 60%;
        }
        .file-list-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #495057;
        }
        .file-list-content {
            padding: 10px;
        }
        
        .file-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-info {
            flex-grow: 1;
        }
        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .file-status {
            font-size: 0.9em;
            color: #6c757d;
        }
        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .file-actions .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        .upload-progress {
            width: 100%;
            height: 1rem;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
            margin-top: 5px;
        }
        .upload-progress-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            background-color: #007bff;
            transition: width .6s ease;
            height: 100%;
            width: 0;
        }
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        
        .print-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .print-settings h4 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
            .right-panel {
                min-height: 60vh;
            }
            body {
                height: auto;
                overflow: visible;
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="left-panel">
        <div class="left-content">
            <h1 class="text-center">å†…ç½‘æ‰“å°æœåŠ¡</h1>
            
            <div class="silent-print-info">
                <strong>ğŸ”§ é™é»˜æ‰“å°åŠŸèƒ½:</strong> ä½¿ç”¨Windowsåº•å±‚æ‰“å°APIï¼Œå®Œå…¨é¿å…å¼¹å‡ºä»»ä½•ç¨‹åºç•Œé¢
            </div>
            
            <div class="conversion-info">
				<strong>è½¬æ¢èƒ½åŠ›çŠ¶æ€:</strong><br>
				<span class="{% if pymupdf_available %}status-good{% else %}status-missing{% endif %}">
					PDFå¤„ç†(PyMuPDF): {{ 'âœ“ å¯ç”¨' if pymupdf_available else 'âœ— æœªå®‰è£… - é™é»˜æ‰“å°åŠŸèƒ½ä¸å¯ç”¨' }}
				</span><br>
				<span class="{% if office_available %}status-good{% else %}status-missing{% endif %}">
					Office COMç»„ä»¶: {{ 'âœ“ å¯ç”¨' if office_available else 'âœ— æœªå®‰è£…Office' }}
				</span>
				<br><small>æ‰€æœ‰è½¬æ¢éƒ½æ˜¯å®Œå…¨é™é»˜çš„ï¼Œä¸ä¼šå¼¹å‡ºä»»ä½•ç•Œé¢</small>
			</div>
            
            <div class="print-settings">
                <h4>æ‰“å°è®¾ç½®</h4>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">é€‰æ‹©æ‰“å°æœº</label>
                        <select id="printerSelect" class="form-select">
                            {% for p in printers %}
                                <option value="{{p}}">{{p}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">æ‰“å°ä»½æ•°</label>
                        <input type="number" id="copiesInput" value="1" min="1" max="10" class="form-control">
                    </div>
                    <div class="col-6">
                        <label class="form-label">çº¸å¼ å¤§å°</label>
                        <input type="text" id="paperSizeInput" value="A4" class="form-control">
                    </div>
                    <div class="col-12">
                        <label class="form-label">å•åŒé¢</label>
                        <select id="duplexSelect" class="form-select">
                            <option value="1">å•é¢</option>
                            <option value="2">é•¿è¾¹ç¿»è½¬åŒé¢</option>
                            <option value="3">çŸ­è¾¹ç¿»è½¬åŒé¢</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button id="printAllBtn" class="btn btn-success w-100">é™é»˜æ‰“å°å…¨éƒ¨PDFæ–‡ä»¶</button>
                    </div>
                </div>
            </div>

            <h4>æ‰“å°æ—¥å¿—</h4>
            <ul class="list-group log-list" id="logList">
                {% for l in logs %}
                    <li class="list-group-item">{{l}}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="right-panel">
        <div class="drop-zone" id="dropZone">
            <input type="file" id="fileInput" multiple style="display: none;">
            <i>ğŸ“„</i>
            <h3>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </h3>
            <p style="margin-bottom: 10px;">æˆ–è€…ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <div class="supported-formats">
                æ”¯æŒæ ¼å¼ï¼šPDFã€å›¾ç‰‡(JPG/PNG/BMP/GIF/TIFF)ã€æ–‡æœ¬(TXT/MD/LOG)ã€Officeæ–‡æ¡£(DOC/DOCX/XLS/XLSX/PPT/PPTX)
            </div>
        </div>
        
        <div class="file-list-container">
            <div class="file-list-header">
                æ–‡ä»¶åˆ—è¡¨
            </div>
            <div class="file-list-content" id="fileList">
            </div>
        </div>
    </div>
</div>

<script src="/static/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const printAllBtn = document.getElementById('printAllBtn');
    const logList = document.getElementById('logList');
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', handleFiles);
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles({target: {files: files}});
    });
    
    function handleFiles(event) {
        const files = Array.from(event.target.files);
        files.forEach(uploadFile);
    }
    
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        const fileItem = createFileItem(file.name, 'å‡†å¤‡ä¸Šä¼ ...', 'info');
        fileList.appendChild(fileItem);
        
        const progressBar = fileItem.querySelector('.upload-progress-bar');
        const progressContainer = fileItem.querySelector('.upload-progress');
        const statusBadge = fileItem.querySelector('.file-status .badge');
        
        // ç¡®ä¿è¿›åº¦æ¡ä»0å¼€å§‹
        progressBar.style.width = '0%';
        progressContainer.style.display = 'block';
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);
        
        // ä¸Šä¼ è¿›åº¦ç›‘å¬
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                if (percentComplete < 100) {
                    statusBadge.textContent = `ä¸Šä¼ ä¸­ ${Math.round(percentComplete)}%`;
                } else {
                    statusBadge.textContent = 'æ–‡ä»¶è½¬æ¢ä¸­...';
                    statusBadge.className = 'badge bg-warning text-dark';
                    progressBar.className = 'upload-progress-bar progress-bar-striped progress-bar-animated';
                }
            }
        };
        
        // è¯·æ±‚å®Œæˆå¤„ç†
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    updateFileItem(fileItem, data);
                    refreshFileList();
                } catch (e) {
                    console.error('è§£æå“åº”å¤±è´¥:', e);
                    updateFileItemStatus(fileItem, 'è§£æå¤±è´¥', 'danger');
                }
            } else {
                console.error('ä¸Šä¼ å¤±è´¥:', xhr.statusText);
                updateFileItemStatus(fileItem, 'ä¸Šä¼ å¤±è´¥', 'danger');
            }
        };
        
        xhr.onerror = function() {
            console.error('ç½‘ç»œé”™è¯¯');
            updateFileItemStatus(fileItem, 'ç½‘ç»œé”™è¯¯', 'danger');
        };
        
        xhr.send(formData);
    }
    
    function createFileItem(filename, status, statusColor) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <div class="file-info">
                <div class="file-name">${filename}</div>
                <div class="file-status">
                    <span class="badge bg-${statusColor}">${status}</span>
                </div>
                <div class="upload-progress" style="display: none;">
                    <div class="upload-progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="file-actions">
            </div>
        `;
        return div;
    }
    
    function updateFileItem(fileItem, data) {
        const statusElement = fileItem.querySelector('.file-status .badge');
        const actionsElement = fileItem.querySelector('.file-actions');
        
        if (data.success) {
            statusElement.textContent = data.converted ? 'å·²è½¬æ¢ä¸ºPDF' : 'å·²ä¸Šä¼ ';
            statusElement.className = `badge bg-${data.converted ? 'success' : 'secondary'}`;
            
            let buttonsHtml = '';
            if (data.converted && data.pdf_name) {
                buttonsHtml += `<button class="btn btn-primary btn-sm" onclick="printFile('${data.filename}')">ğŸ”‡ é™é»˜æ‰“å°</button>`;
                buttonsHtml += `<a href="/preview/${data.pdf_name}" target="_blank" class="btn btn-outline-secondary btn-sm">é¢„è§ˆPDF</a>`;
            } else {
                buttonsHtml += `<span class="text-muted small">æ— æ³•é™é»˜æ‰“å°ï¼Œè¯·å…ˆè½¬æ¢ä¸ºPDF</span>`;
            }
            buttonsHtml += `<a href="/preview/${data.filename}" target="_blank" class="btn btn-outline-info btn-sm">é¢„è§ˆåŸæ–‡ä»¶</a>`;
			buttonsHtml += `<button class="btn btn-danger btn-sm" onclick="showDeleteModal('${data.filename}')">ğŸ—‘ï¸ åˆ é™¤</button>`;
            actionsElement.innerHTML = buttonsHtml;
        } else {
            statusElement.textContent = data.message || 'å¤„ç†å¤±è´¥';
            statusElement.className = 'badge bg-danger';
        }
    }
    
    function updateFileItemStatus(fileItem, status, statusColor) {
        const statusElement = fileItem.querySelector('.file-status .badge');
        statusElement.textContent = status;
        statusElement.className = `badge bg-${statusColor}`;
    }
    
    function refreshFileList() {
        fetch('/api/files')
        .then(response => response.json())
        .then(files => {
            fileList.innerHTML = '';
            files.forEach(file => {
                const fileItem = createFileItem(file.name, file.status, file.status_color);
                updateFileItem(fileItem, {
                    success: true,
                    filename: file.name,
                    converted: file.pdf_path ? true : false,
                    pdf_name: file.pdf_name
                });
                fileList.appendChild(fileItem);
            });
        });
    }
    
    window.printFile = function(filename) {
        const printer = document.getElementById('printerSelect').value;
        const copies = document.getElementById('copiesInput').value;
        const duplex = document.getElementById('duplexSelect').value;
        const paperSize = document.getElementById('paperSizeInput').value;
        
        fetch('/print_single', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                filename: filename,
                printer: printer,
                copies: parseInt(copies),
                duplex: parseInt(duplex),
                paper_size: paperSize,
                quality: 'normal'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogEntry(`âœ“ é™é»˜æ‰“å°æˆåŠŸ: ${filename}`);
            } else {
                addLogEntry(`âœ— é™é»˜æ‰“å°å¤±è´¥: ${filename} - ${data.message}`);
            }
        })
        .catch(error => {
            console.error('é™é»˜æ‰“å°å¤±è´¥:', error);
            addLogEntry(`âœ— é™é»˜æ‰“å°å¤±è´¥: ${filename} - ç½‘ç»œé”™è¯¯`);
        });
    }
    
    printAllBtn.addEventListener('click', function() {
        const printer = document.getElementById('printerSelect').value;
        const copies = document.getElementById('copiesInput').value;
        const duplex = document.getElementById('duplexSelect').value;
        const paperSize = document.getElementById('paperSizeInput').value;
        
        fetch('/print_all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                printer: printer,
                copies: parseInt(copies),
                duplex: parseInt(duplex),
                paper_size: paperSize,
                quality: 'normal'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogEntry(`âœ“ é™é»˜æ‰¹é‡æ‰“å°å®Œæˆï¼Œå…±æ‰“å° ${data.printed_count} ä¸ªæ–‡ä»¶`);
            } else {
                addLogEntry(`âœ— é™é»˜æ‰¹é‡æ‰“å°å¤±è´¥: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('é™é»˜æ‰¹é‡æ‰“å°å¤±è´¥:', error);
            addLogEntry('âœ— é™é»˜æ‰¹é‡æ‰“å°å¤±è´¥: ç½‘ç»œé”™è¯¯');
        });
    });
    
    function addLogEntry(message) {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = new Date().toLocaleString() + ' ' + message;
        logList.insertBefore(li, logList.firstChild);
        
        if (logList.children.length > 10) {
            logList.removeChild(logList.lastChild);
        }
    }
	
	window.showDeleteModal = function(filename) {
		fetch('/api/files')
		.then(response => response.json())
		.then(files => {
			const fileInfo = files.find(f => f.name === filename);
			if (fileInfo) {
				document.getElementById('deleteFileName').textContent = filename;
				document.getElementById('deleteFileSize').textContent = formatFileSize(fileInfo.size);
				document.getElementById('deleteFileTime').textContent = fileInfo.created_time;
				
				const confirmBtn = document.getElementById('confirmDeleteBtn');
				confirmBtn.onclick = () => confirmDelete(filename);
				
				const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
				modal.show();
			}
		})
		.catch(error => {
			console.error('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥:', error);
			alert('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥');
		});
	}

	function confirmDelete(filename) {
		fetch('/delete_file', {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({filename: filename})
		})
		.then(response => response.json())
		.then(data => {
			const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
			modal.hide();
			
			if (data.success) {
				refreshFileList();
			} else {
				addLogEntry(`âŒ åˆ é™¤å¤±è´¥: ${filename} - ${data.message}`);
				alert(`åˆ é™¤å¤±è´¥: ${data.message}`);
			}
		})
		.catch(error => {
			alert('åˆ é™¤å¤±è´¥: ç½‘ç»œé”™è¯¯');
			const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
			modal.hide();
		});
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 B';
		const k = 1024;
		const sizes = ['B', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}
    refreshFileList();
});
</script>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">ç¡®è®¤åˆ é™¤æ–‡ä»¶</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>è­¦å‘Šï¼š</strong> åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼
                </div>
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹æ–‡ä»¶å—ï¼Ÿ</p>
                <div id="deleteFileInfo">
                    <p><strong>æ–‡ä»¶åï¼š</strong> <span id="deleteFileName"></span></p>
                    <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong> <span id="deleteFileSize"></span></p>
                    <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong> <span id="deleteFileTime"></span></p>
                </div>
                <p class="text-muted small">æ³¨æ„ï¼šå°†åŒæ—¶åˆ é™¤æºæ–‡ä»¶å’Œå¯¹åº”çš„PDFæ–‡ä»¶</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>